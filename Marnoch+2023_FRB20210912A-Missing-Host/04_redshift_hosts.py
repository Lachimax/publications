#!/usr/bin/env python
# Code by Lachlan Marnoch, 2023

import os

import craftutils.utils as u
from craftutils.observation.objects import set_cosmology

from lib import *

description = """
Generates the synthetic magnitudes for our FRB hosts at a range of redshifts.
Uses Prospector SED models generated by Gordon et al 2023.
"""


def main(
        output_dir: str,
        input_dir: str,
        cosmo: str
):
    set_output_path(output_dir)
    set_input_path(input_dir)
    set_cosmology(cosmo)
    load_prospector_files()
    for i, frb_name in enumerate(model_dict):
        print(f"Processing {i+1} / {len(model_dict)}:", frb_name, "...")
        model_dict_frb = model_dict[frb_name]
        mag_tbl, flux_tbl = get_mags_shifted(
            model=model_dict_frb["model"],
            z_max=6.,
            n=2000,
            bands=bands_default + bands_wise
        )
        model_dict_frb["mag_table"] = mag_tbl
        mag_tbl.write(
            mag_table_path(frb_name=frb_name),
            overwrite=True
        )
        flux_tbl.write(
            flux_table_path(frb_name=frb_name),
            overwrite=True
        )

        model_path = os.path.join(output_path, "sed_models")
        u.mkdir_check(model_path)
        model_dict_frb["model"].write(os.path.join(model_path, f"{frb_name}_model_table.ecsv"))

        del model_dict_frb["mag_table"]
        del model_dict_frb["model"]


if __name__ == '__main__':
    import argparse

    parser = argparse.ArgumentParser(
        description=description
    )

    parser.add_argument(
        "-o",
        help="Path to output directory.",
        type=str,
        default=default_output_path
    )
    parser.add_argument(
        "-i",
        help="Path to directory containing input files.",
        type=str,
        default=default_input_path
    )
    parser.add_argument(
        "-c",
        help="Preferred cosmology. Should be listed in astropy.cosmology.available.",
        type=str,
        default="Planck18"
    )

    args = parser.parse_args()
    output_path = args.o
    input_path = args.i
    main(
        output_dir=output_path,
        input_dir=input_path,
        cosmo=args.c
    )
